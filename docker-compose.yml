# Ripple Foundation - Security-Hardened Docker Compose
# Docker security best practices for production deployments

services:
  # ============================================
  # CORE SERVICES - With Security Hardening
  # ============================================

  postgres:
    image: postgres:15-alpine
    container_name: ripple-postgres
    environment:
      POSTGRES_USER: ${DB_USER:-ripple_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secure_password_change_this}
      POSTGRES_DB: ripple_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - ripple_internal
    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # Security: Read-only root filesystem
    read_only: true
    # Security: No new privileges
    security_opt:
      - no-new-privileges:true
    # Security:healthcheck
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ripple_user}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ripple-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-change_this_password}
    networks:
      - ripple_internal
    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    # Security: Read-only root filesystem
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # SOLANA LOCALNET (Development Only)
  # ============================================

  solana-test-validator:
    image: solanalabs/solana:v1.18.0
    container_name: ripple-solana
    ports:
      - "8899:8899"  # RPC
      - "8900:8900"  # WebSocket
      - "9900:9900"  # TFT
    networks:
      - ripple_internal
    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
    # Security: Read-only except needed paths
    read_only: true
    volumes:
      - solana_ledger:/mnt/ledger
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    command: >
      solana-test-validator
      --ledger /mnt/ledger
      --mint ${SOLANA_MINT_PUBKEY:-FVWCcxmNp1mSxGNd7fDWEM7ZW7Kb1fXE9XaJgid3rVz}
      --bpf-program R2DyA1jXo1dV3HsQFS7VPE1XqpX9N9wKz4x8y7Z5X3M
      --bpf-program Mem8erS7iP45R1NGrmVYs7eJ6MZYDJ1rG9qkNFYPfvE
      --account-dir /mnt/accounts

  # ============================================
  # SECURITY SERVICES
  # ============================================

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: ripple-vault
    environment:
      DOMAIN: https://vault.${DOMAIN:-localhost}
      SIGNUPS_ALLOWED: "false"  # Disable signups for security
      ADMIN_TOKEN: ${ADMIN_TOKEN:-change_this}
    networks:
      - ripple_internal
      - ripple_external
    ports:
      - "8080:80"
    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    security_opt:
      - no-new-privileges:true
    volumes:
      - vaultwarden_data:/data

  # ============================================
  # MONITORING & AUDIT
  # ============================================

  audit-logger:
    image: fluent/fluent-bit:3.0
    container_name: ripple-audit
    networks:
      - ripple_internal
    volumes:
      - ./docker/fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - audit_logs:/var/log/ripple/audit
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    command: >
      -c /fluent-bit/etc/fluent-bit.conf
      -e /fluent-bit/out_custom.so

# ============================================
# NETWORKS - Security Segmentation
# ============================================

networks:
  ripple_internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
  ripple_external:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16

# ============================================
# VOLUMES - Encrypted Storage
# ============================================

volumes:
  postgres_data:
  redis_data:
  solana_ledger:
  vaultwarden_data:
  audit_logs:

# ============================================
# SECURITY DEFAULTS
# ============================================

x-security-defaults: &security-defaults
  # Run as non-root user (where supported)
  user: "1000:1000"
  # No new privileges
  security_opt:
    - no-new-privileges:true
  # Read-only root filesystem (where possible)
  read_only: true
  # Resource limits (overridden per service)
  deploy:
    resources:
      limits:
        cpus: '2'
        memory: 1G
  # Logging
  logging:
    driver: "json-file"
    options:
      max-size: "100m"
      max-file: "3"
